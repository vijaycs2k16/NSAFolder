var markers=[],polylines=[],alternateRoutes={},path=[],placeIDs={},dragCallback=false,routeSelectboxIt,directionsRenderer;function enableAutoCompleteSearch(map){enableAutoCompleteAddress('fromAddress','fromLat','fromLng',map,null);enableAutoCompleteAddress('toAddress','toLat','toLng',map,null);}
function hideFloatingPanel(){$('.floating-panel-heading').addClass('hide');$('#floating-panel').find('.panel-body').addClass('hide');$('.createStop').removeClass('hide');$("#createStop").addClass('hide-search-route');$(".panel-heading-map").addClass('stop-mark-alone');}
function closeFloatingPanel(){if(!$("#floating-panel-route").hasClass('panel-collapsed')){$("#floating-collapse").click();}}
function openFloatingPanel(){if($("#floating-panel-route").hasClass('panel-collapsed')){$("#floating-collapse").click();}}
function enableAutoCompleteAddress(elementId,lat,lon,map,placeId){var input=document.getElementById(elementId);var autocomplete=new google.maps.places.Autocomplete(input);autocomplete.bindTo('bounds',map);autocomplete.addListener('place_changed',function(){var place=autocomplete.getPlace();if(!place.geometry){return;}
document.getElementById(elementId).value=place.formatted_address;map.setCenter(place.geometry.location);document.getElementById(lat).value=place.geometry.location.lat();document.getElementById(lon).value=place.geometry.location.lng();if(placeId){document.getElementById(placeId).value=place.place_id;}});}
function enableAutoCompleteAddress2(elementId,lat,lon,map,placeId,ind,cb){var input=document.getElementById(elementId);var autocomplete=new google.maps.places.Autocomplete(input);autocomplete.bindTo('bounds',map);autocomplete.addListener('place_changed',function(){var place=autocomplete.getPlace();if(!place.geometry){return;}
map.setCenter(place.geometry.location);cb(place.formatted_address,place.geometry.location.lat(),place.geometry.location.lng(),place.place_id,ind);});}
function requestDirections(map,route,dragRoute,alternateRoute,callback){var routeToDisplay=0,waypts=[],start=new google.maps.LatLng(route.from_lat,route.from_lng),end=new google.maps.LatLng(route.to_lat,route.to_lng);var request={origin:start,destination:end,travelMode:google.maps.DirectionsTravelMode.DRIVING,};if(route!==null&&route.waypoints!==null&&route.id!==null){for(var place_id in route.waypoints){if(route.waypoints.hasOwnProperty(place_id)){var waypoint=route.waypoints[place_id];waypts.push({location:{placeId:waypoint},stopover:true});}}
request.waypoints=waypts;}
request.provideRouteAlternatives=alternateRoute;rendererOptions=getRendererOptions(true,dragRoute);if(directionsRenderer){directionsRenderer.setMap(null);}
directionsRenderer=new google.maps.DirectionsRenderer(rendererOptions);var directionsService=new google.maps.DirectionsService();directionsService.route(request,function(result,status){if(status==google.maps.DirectionsStatus.OK){renderDirections(map,result,directionsRenderer,0,callback);var options=[];for(var i=0;i<result.routes.length;i++){options.push({text:result.routes[i].summary,value:i});}
dragCallback=true;callback(directionsRenderer);}});}
function getRendererOptions(main_route,dragRoute){if(main_route){var _colour='#808080';var _strokeWeight=3;var _strokeOpacity=0.7;var _suppressMarkers=false;}
else{var _colour='#808080';var _strokeWeight=2;var _strokeOpacity=0.7;var _suppressMarkers=false;}
var polylineOptions={strokeColor:_colour,strokeWeight:_strokeWeight,strokeOpacity:_strokeOpacity};var rendererOptions={draggable:dragRoute,suppressMarkers:_suppressMarkers,polylineOptions:polylineOptions};return rendererOptions;}
function renderDirections(map,result,directionsRenderer,routeToDisplay,callback){var polylineOptions={path:[],strokeColor:'#808080',strokeWeight:3,strokeOpacity:0.7};var dragPolylineOptions={path:[],strokeColor:'#00B3FD',strokeWeight:3,strokeOpacity:0.8};var polyline=new google.maps.Polyline(polylineOptions);polylines[routeToDisplay]=polyline;directionsRenderer.setMap(map);directionsRenderer.setDirections(result);alternateRoutes[routeToDisplay]=directionsRenderer;google.maps.event.addListener(directionsRenderer,'directions_changed',function(e){var currentPolyline=polylines[directionsRenderer.routeIndex];currentPolyline.setOptions(dragPolylineOptions);currentPolyline.setPath([]);currentPolyline.setMap(null);directionsRenderer.polylineOptions=dragPolylineOptions;placeIDs={};var geo_wp=directionsRenderer.directions.geocoded_waypoints;for(ind=0;ind<geo_wp.length;ind++){getLocationFromPlaceId(geo_wp[ind].place_id,function(latlng){placeIDs[latlng.lat()]=latlng.lng()+'';});}
if(routeSelectboxIt!==undefined){$("#selectRoute").selectBoxIt('disable');}
callback(directionsRenderer);});}
function getWaypoints(){return placeIDs;}
function getLocationFromPlaceId(placeId,callback){var geocoder=new google.maps.Geocoder;geocoder.geocode({'placeId':placeId},function(results,status){if(status==='OK'){callback(results[0].geometry.location);}});}
function dragPolyline(map,polyline,response){polyline.setPath(response.directions.routes[0].overview_path);polyline.setMap(map);polylines[response.routeIndex]=polyline;for(k=0;k<Object.keys(polylines).length;k++){if(k!==response.routeIndex){polylines[k].setMap(null);alternateRoutes[k].setMap(null);}}}
function createMarker(map,latlng,label,radius,draggable,markerIcon){var marker=new google.maps.Marker({position:latlng,map:map,title:label,draggable:draggable,zIndex:Math.round(latlng.lat()*-100000)<<5});if(markerIcon!=null){marker.setIcon(markerIcon);}
setTimeout(function(){map.setCenter(latlng);},200);if(radius>0){var populationOptions={strokeColor:'#b41b1b',strokeOpacity:0.5,strokeWeight:1,fillColor:'#b41b1b',fillOpacity:0.2,map:map,center:latlng,radius:parseInt(radius)};var stopCircle=new google.maps.Circle(populationOptions);stopCircle.bindTo('center',marker,'position');marker._myCircle=stopCircle;marker.myname=label;marker.radius=radius;}
var infowindow=new google.maps.InfoWindow({size:new google.maps.Size(150,50)});if(draggable){google.maps.event.addListener(marker,'dragend',function(evt){openInfoWindow(evt,map,marker,infowindow,label);});}
google.maps.event.addListener(marker,'click',function(evt){openInfoWindow(evt,map,marker,infowindow,label);});markers.push(marker);return marker;}
function openInfoWindow(evt,map,marker,infowindow,text){new google.maps.Geocoder().geocode({'latLng':evt.latLng},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(results[0]){marker.address=results[0].formatted_address;infowindow.setContent("<b>"+marker.getTitle()+" :</b>&nbsp;"+results[0].formatted_address);infowindow.open(map,marker);}}});}
function getMapFormData(markers){var stoppings={};for(j=0;j<markers.length;j++){var stopData={};stopData.lat=markers[j].getPosition().lat();stopData.lng=markers[j].getPosition().lng();stopData.address=markers[j].address;stoppings[j]=JSON.stringify(stopData);}
var fromData=serializeFormJSON($(".routeWizardForm"));fromData.stops=stoppings;fromData.waypoints=placeIDs;return fromData;}
function createVehilceMarker(map,lat,lng,title,label){var car="M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z";var image={url:'http://localhost:3002/public/assets/images/bussmall.svg',anchor:new google.maps.Point(10,25)}
icon={labelOrigin:new google.maps.Point(50,50),path:car,scale:.5,strokeColor:'black',strokeWeight:.9,fillOpacity:1,fillColor:'#febf01',offset:'5%',anchor:new google.maps.Point(10,25)};var latlng=new google.maps.LatLng(lat,lng);var labelText="City Hall";var vehicleMarker=new MarkerWithLabel({position:latlng,map:map,icon:icon,title:title,draggable:false,labelContent:label.text,labelAnchor:new google.maps.Point(30,-10),labelClass:"labels",labelStyle:{border:"1px solid black",textAlign:"center",fontSize:"8pt",width:"75px",'background-color':'white','margin-top':'10px'}});var infowindow=new google.maps.InfoWindow({size:new google.maps.Size(150,50)});google.maps.event.addListener(vehicleMarker,'click',function(evt){openInfoWindow(evt,map,vehicleMarker,infowindow,label.text);});map.panTo(latlng);map.setZoom(17);return vehicleMarker;}
function createPolyline(color){var polyline=new google.maps.Polyline({path:[],strokeColor:color,strokeWeight:3});return polyline;}