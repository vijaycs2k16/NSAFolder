'use strict';

var Promise = require('bluebird');

var readdirp = require('readdirp');
var util = require('util');
var async = require('async');
var _ = require('lodash');

var cql = Promise.promisifyAll(require('dse-driver'));
var ORM = Promise.promisifyAll(require('./orm/apollo'));
var debug = require('debug')('express-cassandra');

var CassandraClient = function f(options) {
  var self = this;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
};

CassandraClient.createClient = function (options) {
  return new CassandraClient(options);
};

CassandraClient.setDirectory = function (directory) {
  CassandraClient.directory = directory;
  return CassandraClient;
};

CassandraClient.bind = function (options, cb) {
  var self = CassandraClient;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
  self.orm.connect(function (err) {
    if (err) {
      if (cb) cb(err);
      return;
    }

    readdirp({
      root: self.directory,
      fileFilter: ['*.js', '*.javascript', '*.jsx', '*.coffee', '*.coffeescript', '*.iced', '*.script', '*.ts', '*.tsx', '*.typescript', '*.cjsx', '*.co', '*.json', '*.json5', '*.litcoffee', '*.liticed', '*.ls', '*.node', '*.toml', '*.wisp']
    }, function (err1, list) {
      if (err1 && err1.length > 0) {
        if (cb) cb(err1[0]);
        return;
      }

      list = list.files;

      async.each(list, function (file, callback) {
        if (file.name.indexOf('Model') === -1) {
          callback();
          return;
        }

        var modelName = self._translateFileNameToModelName(file.name);

        if (modelName) {
          var filePath = util.format('%s/%s', self.directory, file.path);
          // eslint-disable-next-line import/no-dynamic-require
          var modelSchema = require(filePath);
          self.modelInstance[modelName] = self.orm.add_model(modelName.toLowerCase(), modelSchema, function (err2) {
            if (err2) callback(err2);else callback();
          });
          self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
        } else {
          callback();
        }
      }, function (err3) {
        if (err3 && cb) {
          cb(err3);
        } else if (cb) {
          cb();
        }
      });
    });
  });
};

CassandraClient.bindAsync = Promise.promisify(CassandraClient.bind);

CassandraClient.prototype.connect = function f(callback) {
  var self = this;
  self.orm.connect(callback);
};

CassandraClient.prototype.connectAsync = Promise.promisify(CassandraClient.prototype.connect);

CassandraClient.prototype.loadSchema = function f(modelName, modelSchema, callback) {
  var self = this;
  var cb = function cb(err) {
    if (typeof callback === 'function') {
      if (err) callback(err);else callback(null, self.modelInstance[modelName]);
    }
  };
  self.modelInstance[modelName] = self.orm.add_model(modelName, modelSchema, cb);
  self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
  return self.modelInstance[modelName];
};

CassandraClient.prototype.loadSchemaAsync = function f(modelName, modelSchema) {
  var _this = this;

  return new Promise(function (resolve, reject) {
    _this.loadSchema(modelName, modelSchema, function (err, Model) {
      if (err) reject(err);else resolve(Model);
    });
  });
};

CassandraClient.uuid = function () {
  return cql.types.Uuid.random();
};

CassandraClient.uuidFromString = function (str) {
  return cql.types.Uuid.fromString(str);
};

CassandraClient.uuidFromBuffer = function (buf) {
  return new cql.types.Uuid(buf);
};

CassandraClient.timeuuid = function () {
  return cql.types.TimeUuid.now();
};

CassandraClient.timeuuidFromDate = function (date) {
  return cql.types.TimeUuid.fromDate(date);
};

CassandraClient.timeuuidFromString = function (str) {
  return cql.types.TimeUuid.fromString(str);
};

CassandraClient.timeuuidFromBuffer = function (buf) {
  return new cql.types.TimeUuid(buf);
};

CassandraClient.maxTimeuuid = function (date) {
  return cql.types.TimeUuid.max(date);
};

CassandraClient.minTimeuuid = function (date) {
  return cql.types.TimeUuid.min(date);
};

CassandraClient.prototype.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  var randomModel = this.modelInstance[Object.keys(this.modelInstance)[0]];
  var builtQueries = [];
  var beforeHooks = [];
  for (var i = 0; i < queries.length; i++) {
    builtQueries.push({
      query: queries[i].query,
      params: queries[i].params
    });
    var beforeHookAsync = Promise.promisify(queries[i].before_hook);
    beforeHooks.push(beforeHookAsync());
  }

  var batchResult = void 0;
  Promise.all(beforeHooks).then(function () {
    if (builtQueries.length > 1) {
      return randomModel.execute_batchAsync(builtQueries, options);
    }
    if (builtQueries.length > 0) {
      debug('single query provided for batch request, applying as non batch query');
      return randomModel.execute_queryAsync(builtQueries[0].query, builtQueries[0].params, options);
    }
    debug('no queries provided for batch request, empty array found, doing nothing');
    return {};
  }).then(function (response) {
    batchResult = response;
    var afterHooks = [];
    for (var _i = 0; _i < queries.length; _i++) {
      var afterHookAsync = Promise.promisify(queries[_i].after_hook);
      afterHooks.push(afterHookAsync());
    }
    return Promise.all(afterHooks);
  }).then(function () {
    callback(null, batchResult);
  }).catch(function (err) {
    callback(err);
  });
};

CassandraClient.prototype.doBatchAsync = Promise.promisify(CassandraClient.prototype.doBatch);

CassandraClient.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  CassandraClient.prototype.doBatch.call(CassandraClient, queries, options, callback);
};

CassandraClient.doBatchAsync = Promise.promisify(CassandraClient.doBatch);

CassandraClient._translateFileNameToModelName = function (fileName) {
  return fileName.slice(0, fileName.lastIndexOf('.')).replace('Model', '');
};

Object.defineProperties(CassandraClient, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return CassandraClient.modelInstance;
    }
  },
  close: {
    get: function get() {
      return CassandraClient.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(CassandraClient.orm.close);
    }
  }
});

Object.defineProperties(CassandraClient.prototype, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return this.modelInstance;
    }
  },
  close: {
    get: function get() {
      return this.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(this.orm.close);
    }
  }
});

CassandraClient.prototype.uuid = CassandraClient.uuid;
CassandraClient.prototype.uuidFromString = CassandraClient.uuidFromString;
CassandraClient.prototype.uuidFromBuffer = CassandraClient.uuidFromBuffer;
CassandraClient.prototype.timeuuid = CassandraClient.timeuuid;
CassandraClient.prototype.timeuuidFromDate = CassandraClient.timeuuidFromDate;
CassandraClient.prototype.timeuuidFromString = CassandraClient.timeuuidFromString;
CassandraClient.prototype.timeuuidFromBuffer = CassandraClient.timeuuidFromBuffer;
CassandraClient.prototype.maxTimeuuid = CassandraClient.maxTimeuuid;
CassandraClient.prototype.minTimeuuid = CassandraClient.minTimeuuid;

CassandraClient.prototype._translateFileNameToModelName = CassandraClient._translateFileNameToModelName;

module.exports = CassandraClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzQ2Fzc2FuZHJhLmpzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwicmVhZGRpcnAiLCJ1dGlsIiwiYXN5bmMiLCJfIiwiY3FsIiwicHJvbWlzaWZ5QWxsIiwiT1JNIiwiZGVidWciLCJDYXNzYW5kcmFDbGllbnQiLCJmIiwib3B0aW9ucyIsInNlbGYiLCJtb2RlbEluc3RhbmNlIiwib3JtIiwiY2xpZW50T3B0aW9ucyIsIm9ybU9wdGlvbnMiLCJjcmVhdGVDbGllbnQiLCJzZXREaXJlY3RvcnkiLCJkaXJlY3RvcnkiLCJiaW5kIiwiY2IiLCJjb25uZWN0IiwiZXJyIiwicm9vdCIsImZpbGVGaWx0ZXIiLCJlcnIxIiwibGlzdCIsImxlbmd0aCIsImZpbGVzIiwiZWFjaCIsImZpbGUiLCJjYWxsYmFjayIsIm5hbWUiLCJpbmRleE9mIiwibW9kZWxOYW1lIiwiX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWUiLCJmaWxlUGF0aCIsImZvcm1hdCIsInBhdGgiLCJtb2RlbFNjaGVtYSIsImFkZF9tb2RlbCIsInRvTG93ZXJDYXNlIiwiZXJyMiIsImVycjMiLCJiaW5kQXN5bmMiLCJwcm9taXNpZnkiLCJwcm90b3R5cGUiLCJjb25uZWN0QXN5bmMiLCJsb2FkU2NoZW1hIiwibG9hZFNjaGVtYUFzeW5jIiwicmVzb2x2ZSIsInJlamVjdCIsIk1vZGVsIiwidXVpZCIsInR5cGVzIiwiVXVpZCIsInJhbmRvbSIsInV1aWRGcm9tU3RyaW5nIiwic3RyIiwiZnJvbVN0cmluZyIsInV1aWRGcm9tQnVmZmVyIiwiYnVmIiwidGltZXV1aWQiLCJUaW1lVXVpZCIsIm5vdyIsInRpbWV1dWlkRnJvbURhdGUiLCJkYXRlIiwiZnJvbURhdGUiLCJ0aW1ldXVpZEZyb21TdHJpbmciLCJ0aW1ldXVpZEZyb21CdWZmZXIiLCJtYXhUaW1ldXVpZCIsIm1heCIsIm1pblRpbWV1dWlkIiwibWluIiwiZG9CYXRjaCIsInF1ZXJpZXMiLCJhcmd1bWVudHMiLCJkZWZhdWx0cyIsInByZXBhcmUiLCJkZWZhdWx0c0RlZXAiLCJyYW5kb21Nb2RlbCIsIk9iamVjdCIsImtleXMiLCJidWlsdFF1ZXJpZXMiLCJiZWZvcmVIb29rcyIsImkiLCJwdXNoIiwicXVlcnkiLCJwYXJhbXMiLCJiZWZvcmVIb29rQXN5bmMiLCJiZWZvcmVfaG9vayIsImJhdGNoUmVzdWx0IiwiYWxsIiwidGhlbiIsImV4ZWN1dGVfYmF0Y2hBc3luYyIsImV4ZWN1dGVfcXVlcnlBc3luYyIsInJlc3BvbnNlIiwiYWZ0ZXJIb29rcyIsImFmdGVySG9va0FzeW5jIiwiYWZ0ZXJfaG9vayIsImNhdGNoIiwiZG9CYXRjaEFzeW5jIiwiY2FsbCIsImZpbGVOYW1lIiwic2xpY2UiLCJsYXN0SW5kZXhPZiIsInJlcGxhY2UiLCJkZWZpbmVQcm9wZXJ0aWVzIiwiY29uc2lzdGVuY2llcyIsImdldCIsImRhdGF0eXBlcyIsImRyaXZlciIsImluc3RhbmNlIiwiY2xvc2UiLCJjbG9zZUFzeW5jIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNQSxVQUFVQyxRQUFRLFVBQVIsQ0FBaEI7O0FBRUEsSUFBTUMsV0FBV0QsUUFBUSxVQUFSLENBQWpCO0FBQ0EsSUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLE9BQVIsQ0FBZDtBQUNBLElBQU1JLElBQUlKLFFBQVEsUUFBUixDQUFWOztBQUVBLElBQU1LLE1BQU1OLFFBQVFPLFlBQVIsQ0FBcUJOLFFBQVEsWUFBUixDQUFyQixDQUFaO0FBQ0EsSUFBTU8sTUFBTVIsUUFBUU8sWUFBUixDQUFxQk4sUUFBUSxjQUFSLENBQXJCLENBQVo7QUFDQSxJQUFNUSxRQUFRUixRQUFRLE9BQVIsRUFBaUIsbUJBQWpCLENBQWQ7O0FBRUEsSUFBTVMsa0JBQWtCLFNBQVNDLENBQVQsQ0FBV0MsT0FBWCxFQUFvQjtBQUMxQyxNQUFNQyxPQUFPLElBQWI7QUFDQUEsT0FBS0MsYUFBTCxHQUFxQixFQUFy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aEcsR0FBTCxDQUFTb0csS0FBaEI7QUFDRDtBQUhJLEdBckIwQztBQTBCakRDLGNBQVk7QUFDVkwsT0FEVSxpQkFDSjtBQUNKLGFBQU8vRyxRQUFRK0MsU0FBUixDQUFrQixLQUFLaEMsR0FBTCxDQUFTb0csS0FBM0IsQ0FBUDtBQUNEO0FBSFM7QUExQnFDLENBQW5EOztBQWtDQXpHLGdCQUFnQnNDLFNBQWhCLENBQTBCTyxJQUExQixHQUFpQzdDLGdCQUFnQjZDLElBQWpEO0FBQ0E3QyxnQkFBZ0JzQyxTQUFoQixDQUEwQlcsY0FBMUIsR0FBMkNqRCxnQkFBZ0JpRCxjQUEzRDtBQUNBakQsZ0JBQWdCc0MsU0FBaEIsQ0FBMEJjLGNBQTFCLEdBQTJDcEQsZ0JBQWdCb0QsY0FBM0Q7QUFDQXBELGdCQUFnQnNDLFNBQWhCLENBQTBCZ0IsUUFBMUIsR0FBcUN0RCxnQkFBZ0JzRCxRQUFyRDtBQUNBdEQsZ0JBQWdCc0MsU0FBaEIsQ0FBMEJtQixnQkFBMUIsR0FBNkN6RCxnQkFBZ0J5RCxnQkFBN0Q7QUFDQXpELGdCQUFnQnNDLFNBQWhCLENBQTBCc0Isa0JBQTFCLEdBQStDNUQsZ0JBQWdCNEQsa0JBQS9EO0FBQ0E1RCxnQkFBZ0JzQyxTQUFoQixDQUEwQnVCLGtCQUExQixHQUErQzdELGdCQUFnQjZELGtCQUEvRDtBQUNBN0QsZ0JBQWdCc0MsU0FBaEIsQ0FBMEJ3QixXQUExQixHQUF3QzlELGdCQUFnQjhELFdBQXhEO0FBQ0E5RCxnQkFBZ0JzQyxTQUFoQixDQUEwQjBCLFdBQTFCLEdBQXdDaEUsZ0JBQWdCZ0UsV0FBeEQ7O0FBRUFoRSxnQkFBZ0JzQyxTQUFoQixDQUEwQlgsNkJBQTFCLEdBQTBEM0IsZ0JBQWdCMkIsNkJBQTFFOztBQUVBZ0YsT0FBT0MsT0FBUCxHQUFpQjVHLGVBQWpCIiwiZmlsZSI6ImV4cHJlc3NDYXNzYW5kcmEuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcblxuY29uc3QgcmVhZGRpcnAgPSByZXF1aXJlKCdyZWFkZGlycCcpO1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbmNvbnN0IGFzeW5jID0gcmVxdWlyZSgnYXN5bmMnKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcblxuY29uc3QgY3FsID0gUHJvbWlzZS5wcm9taXNpZnlBbGwocmVxdWlyZSgnZHNlLWRyaXZlcicpKTtcbmNvbnN0IE9STSA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJy4vb3JtL2Fwb2xsbycpKTtcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnZXhwcmVzcy1jYXNzYW5kcmEnKTtcblxuY29uc3QgQ2Fzc2FuZHJhQ2xpZW50ID0gZnVuY3Rpb24gZihvcHRpb25zKSB7XG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuICBzZWxmLm1vZGVsSW5zdGFuY2UgPSB7fTtcbiAgc2VsZi5vcm0gPSBuZXcgT1JNKG9wdGlvbnMuY2xpZW50T3B0aW9ucywgb3B0aW9ucy5vcm1PcHRpb25zKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5jcmVhdGVDbGllbnQgPSAob3B0aW9ucykgPT4gKG5ldyBDYXNzYW5kcmFDbGllbnQob3B0aW9ucykpO1xuXG5DYXNzYW5kcmFDbGllbnQuc2V0RGlyZWN0b3J5ID0gKGRpcmVjdG9yeSkgPT4ge1xuICBDYXNzYW5kcmFDbGllbnQuZGlyZWN0b3J5ID0gZGlyZWN0b3J5O1xuICByZXR1cm4gQ2Fzc2FuZHJhQ2xpZW50O1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmJpbmQgPSAob3B0aW9ucywgY2IpID0+IHtcbiAgY29uc3Qgc2VsZiA9IENhc3NhbmRyYUNsaWVudDtcbiAgc2VsZi5tb2RlbEluc3RhbmNlID0ge307XG4gIHNlbGYub3JtID0gbmV3IE9STShvcHRpb25zLmNsaWVudE9wdGlvbnMsIG9wdGlvbnMub3JtT3B0aW9ucyk7XG4gIHNlbGYub3JtLmNvbm5lY3QoKGVycikgPT4ge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGlmIChjYikgY2IoZXJyKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZWFkZGlycCh7XG4gICAgICByb290OiBzZWxmLmRpcmVjdG9yeSxcbiAgICAgIGZpbGVGaWx0ZXI6IFtcbiAgICAgICAgJyouanMnLCAnKi5qYXZhc2NyaXB0JywgJyouanN4JywgJyouY29mZmVlJywgJyouY29mZmVlc2NyaXB0JywgJyouaWNlZCcsXG4gICAgICAgICcqLnNjcmlwdCcsICcqLnRzJywgJyoudHN4JywgJyoudHlwZXNjcmlwdCcsICcqLmNqc3gnLCAnKi5jbycsICcqLmpzb24nLFxuICAgICAgICAnKi5qc29uNScsICcqLmxpdGNvZmZlZScsICcqLmxpdGljZWQnLCAnKi5scycsICcqLm5vZGUnLCAnKi50b21sJywgJyoud2lzcCcsXG4gICAgICBdLFxuICAgIH0sIChlcnIxLCBsaXN0KSA9PiB7XG4gICAgICBpZiAoZXJyMSAmJiBlcnIxLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaWYgKGNiKSBjYihlcnIxWzBdKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsaXN0ID0gbGlzdC5maWxlcztcblxuICAgICAgYXN5bmMuZWFjaChsaXN0LCAoZmlsZSwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgaWYgKGZpbGUubmFtZS5pbmRleE9mKCdNb2RlbCcpID09PSAtMSkge1xuICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbW9kZWxOYW1lID0gc2VsZi5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZShmaWxlLm5hbWUpO1xuXG4gICAgICAgIGlmIChtb2RlbE5hbWUpIHtcbiAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHV0aWwuZm9ybWF0KCclcy8lcycsIHNlbGYuZGlyZWN0b3J5LCBmaWxlLnBhdGgpO1xuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICAgICAgY29uc3QgbW9kZWxTY2hlbWEgPSByZXF1aXJlKGZpbGVQYXRoKTtcbiAgICAgICAgICBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSA9IHNlbGYub3JtLmFkZF9tb2RlbChcbiAgICAgICAgICAgIG1vZGVsTmFtZS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgbW9kZWxTY2hlbWEsXG4gICAgICAgICAgICAoZXJyMikgPT4ge1xuICAgICAgICAgICAgICBpZiAoZXJyMikgY2FsbGJhY2soZXJyMik7XG4gICAgICAgICAgICAgIGVsc2UgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgKTtcbiAgICAgICAgICBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICB9LCAoZXJyMykgPT4ge1xuICAgICAgICBpZiAoZXJyMyAmJiBjYikge1xuICAgICAgICAgIGNiKGVycjMpO1xuICAgICAgICB9IGVsc2UgaWYgKGNiKSB7XG4gICAgICAgICAgY2IoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmJpbmRBc3luYyA9IFByb21pc2UucHJvbWlzaWZ5KENhc3NhbmRyYUNsaWVudC5iaW5kKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gZihjYWxsYmFjaykge1xuICBjb25zdCBzZWxmID0gdGhpcztcbiAgc2VsZi5vcm0uY29ubmVjdChjYWxsYmFjayk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmNvbm5lY3RBc3luYyA9IFByb21pc2UucHJvbWlzaWZ5KENhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuY29ubmVjdCk7XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUubG9hZFNjaGVtYSA9IGZ1bmN0aW9uIGYobW9kZWxOYW1lLCBtb2RlbFNjaGVtYSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gIGNvbnN0IGNiID0gZnVuY3Rpb24gY2IoZXJyKSB7XG4gICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaWYgKGVycikgY2FsbGJhY2soZXJyKTtcbiAgICAgIGVsc2UgY2FsbGJhY2sobnVsbCwgc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0pO1xuICAgIH1cbiAgfTtcbiAgc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0gPSBzZWxmLm9ybS5hZGRfbW9kZWwobW9kZWxOYW1lLCBtb2RlbFNjaGVtYSwgY2IpO1xuICBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdKTtcbiAgcmV0dXJuIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdO1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5sb2FkU2NoZW1hQXN5bmMgPSBmdW5jdGlvbiBmKG1vZGVsTmFtZSwgbW9kZWxTY2hlbWEpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB0aGlzLmxvYWRTY2hlbWEobW9kZWxOYW1lLCBtb2RlbFNjaGVtYSwgKGVyciwgTW9kZWwpID0+IHtcbiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgZWxzZSByZXNvbHZlKE1vZGVsKTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQudXVpZCA9ICgpID0+IChjcWwudHlwZXMuVXVpZC5yYW5kb20oKSk7XG5cbkNhc3NhbmRyYUNsaWVudC51dWlkRnJvbVN0cmluZyA9IChzdHIpID0+IChjcWwudHlwZXMuVXVpZC5mcm9tU3RyaW5nKHN0cikpO1xuXG5DYXNzYW5kcmFDbGllbnQudXVpZEZyb21CdWZmZXIgPSAoYnVmKSA9PiAobmV3IGNxbC50eXBlcy5VdWlkKGJ1ZikpO1xuXG5DYXNzYW5kcmFDbGllbnQudGltZXV1aWQgPSAoKSA9PiAoY3FsLnR5cGVzLlRpbWVVdWlkLm5vdygpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbURhdGUgPSAoZGF0ZSkgPT4gKGNxbC50eXBlcy5UaW1lVXVpZC5mcm9tRGF0ZShkYXRlKSk7XG5cbkNhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21TdHJpbmcgPSAoc3RyKSA9PiAoY3FsLnR5cGVzLlRpbWVVdWlkLmZyb21TdHJpbmcoc3RyKSk7XG5cbkNhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21CdWZmZXIgPSAoYnVmKSA9PiAobmV3IGNxbC50eXBlcy5UaW1lVXVpZChidWYpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1heFRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWF4KGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1pblRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWluKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoID0gZnVuY3Rpb24gZihxdWVyaWVzLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICBvcHRpb25zID0ge307XG4gIH1cblxuICBjb25zdCBkZWZhdWx0cyA9IHtcbiAgICBwcmVwYXJlOiB0cnVlLFxuICB9O1xuXG4gIG9wdGlvbnMgPSBfLmRlZmF1bHRzRGVlcChvcHRpb25zLCBkZWZhdWx0cyk7XG5cbiAgY29uc3QgcmFuZG9tTW9kZWwgPSB0aGlzLm1vZGVsSW5zdGFuY2VbT2JqZWN0LmtleXModGhpcy5tb2RlbEluc3RhbmNlKVswXV07XG4gIGNvbnN0IGJ1aWx0UXVlcmllcyA9IFtdO1xuICBjb25zdCBiZWZvcmVIb29rcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXJpZXMubGVuZ3RoOyBpKyspIHtcbiAgICBidWlsdFF1ZXJpZXMucHVzaCh7XG4gICAgICBxdWVyeTogcXVlcmllc1tpXS5xdWVyeSxcbiAgICAgIHBhcmFtczogcXVlcmllc1tpXS5wYXJhbXMsXG4gICAgfSk7XG4gICAgY29uc3QgYmVmb3JlSG9va0FzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkocXVlcmllc1tpXS5iZWZvcmVfaG9vayk7XG4gICAgYmVmb3JlSG9va3MucHVzaChiZWZvcmVIb29rQXN5bmMoKSk7XG4gIH1cblxuICBsZXQgYmF0Y2hSZXN1bHQ7XG4gIFByb21pc2UuYWxsKGJlZm9yZUhvb2tzKVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIGlmIChidWlsdFF1ZXJpZXMubGVuZ3RoID4gMSkge1xuICAgICAgICByZXR1cm4gcmFuZG9tTW9kZWwuZXhlY3V0ZV9iYXRjaEFzeW5jKGJ1aWx0UXVlcmllcywgb3B0aW9ucyk7XG4gICAgICB9XG4gICAgICBpZiAoYnVpbHRRdWVyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZGVidWcoJ3NpbmdsZSBxdWVyeSBwcm92aWRlZCBmb3IgYmF0Y2ggcmVxdWVzdCwgYXBwbHlpbmcgYXMgbm9uIGJhdGNoIHF1ZXJ5Jyk7XG4gICAgICAgIHJldHVybiByYW5kb21Nb2RlbC5leGVjdXRlX3F1ZXJ5QXN5bmMoYnVpbHRRdWVyaWVzWzBdLnF1ZXJ5LCBidWlsdFF1ZXJpZXNbMF0ucGFyYW1zLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICAgIGRlYnVnKCdubyBxdWVyaWVzIHByb3ZpZGVkIGZvciBiYXRjaCByZXF1ZXN0LCBlbXB0eSBhcnJheSBmb3VuZCwgZG9pbmcgbm90aGluZycpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH0pXG4gICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBiYXRjaFJlc3VsdCA9IHJlc3BvbnNlO1xuICAgICAgY29uc3QgYWZ0ZXJIb29rcyA9IFtdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWVyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGFmdGVySG9va0FzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkocXVlcmllc1tpXS5hZnRlcl9ob29rKTtcbiAgICAgICAgYWZ0ZXJIb29rcy5wdXNoKGFmdGVySG9va0FzeW5jKCkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGFmdGVySG9va3MpO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwgYmF0Y2hSZXN1bHQpO1xuICAgIH0pXG4gICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNhbGxiYWNrKGVycik7XG4gICAgfSk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmRvQmF0Y2hBc3luYyA9IFByb21pc2UucHJvbWlzaWZ5KENhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuZG9CYXRjaCk7XG5cbkNhc3NhbmRyYUNsaWVudC5kb0JhdGNoID0gZnVuY3Rpb24gZihxdWVyaWVzLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICBvcHRpb25zID0ge307XG4gIH1cblxuICBjb25zdCBkZWZhdWx0cyA9IHtcbiAgICBwcmVwYXJlOiB0cnVlLFxuICB9O1xuXG4gIG9wdGlvbnMgPSBfLmRlZmF1bHRzRGVlcChvcHRpb25zLCBkZWZhdWx0cyk7XG5cbiAgQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoLmNhbGwoQ2Fzc2FuZHJhQ2xpZW50LCBxdWVyaWVzLCBvcHRpb25zLCBjYWxsYmFjayk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQuZG9CYXRjaEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LmRvQmF0Y2gpO1xuXG5DYXNzYW5kcmFDbGllbnQuX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWUgPSAoZmlsZU5hbWUpID0+IChcbiAgZmlsZU5hbWUuc2xpY2UoMCwgZmlsZU5hbWUubGFzdEluZGV4T2YoJy4nKSkucmVwbGFjZSgnTW9kZWwnLCAnJylcbik7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENhc3NhbmRyYUNsaWVudCwge1xuICBjb25zaXN0ZW5jaWVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcy5jb25zaXN0ZW5jaWVzO1xuICAgIH0sXG4gIH0sXG4gIGRhdGF0eXBlczoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWwudHlwZXM7XG4gICAgfSxcbiAgfSxcbiAgZHJpdmVyOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbDtcbiAgICB9LFxuICB9LFxuICBpbnN0YW5jZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBDYXNzYW5kcmFDbGllbnQubW9kZWxJbnN0YW5jZTtcbiAgICB9LFxuICB9LFxuICBjbG9zZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBDYXNzYW5kcmFDbGllbnQub3JtLmNsb3NlO1xuICAgIH0sXG4gIH0sXG4gIGNsb3NlQXN5bmM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50Lm9ybS5jbG9zZSk7XG4gICAgfSxcbiAgfSxcbn0pO1xuXG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKENhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUsIHtcbiAgY29uc2lzdGVuY2llczoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWwudHlwZXMuY29uc2lzdGVuY2llcztcbiAgICB9LFxuICB9LFxuICBkYXRhdHlwZXM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsLnR5cGVzO1xuICAgIH0sXG4gIH0sXG4gIGRyaXZlcjoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWw7XG4gICAgfSxcbiAgfSxcbiAgaW5zdGFuY2U6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gdGhpcy5tb2RlbEluc3RhbmNlO1xuICAgIH0sXG4gIH0sXG4gIGNsb3NlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHRoaXMub3JtLmNsb3NlO1xuICAgIH0sXG4gIH0sXG4gIGNsb3NlQXN5bmM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkodGhpcy5vcm0uY2xvc2UpO1xuICAgIH0sXG4gIH0sXG59KTtcblxuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnV1aWQgPSBDYXNzYW5kcmFDbGllbnQudXVpZDtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudXVpZEZyb21TdHJpbmcgPSBDYXNzYW5kcmFDbGllbnQudXVpZEZyb21TdHJpbmc7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnV1aWRGcm9tQnVmZmVyID0gQ2Fzc2FuZHJhQ2xpZW50LnV1aWRGcm9tQnVmZmVyO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZCA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZDtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudGltZXV1aWRGcm9tRGF0ZSA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21EYXRlO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZEZyb21TdHJpbmcgPSBDYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tU3RyaW5nO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZEZyb21CdWZmZXIgPSBDYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tQnVmZmVyO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5tYXhUaW1ldXVpZCA9IENhc3NhbmRyYUNsaWVudC5tYXhUaW1ldXVpZDtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUubWluVGltZXV1aWQgPSBDYXNzYW5kcmFDbGllbnQubWluVGltZXV1aWQ7XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWUgPSBDYXNzYW5kcmFDbGllbnQuX3RyYW5zbGF0ZUZpbGVOYW1lVG9Nb2RlbE5hbWU7XG5cbm1vZHVsZS5leHBvcnRzID0gQ2Fzc2FuZHJhQ2xpZW50O1xuIl19