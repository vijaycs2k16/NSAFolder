'use strict';

var Promise = require('bluebird');

var fs = require('fs');
var util = require('util');
var async = require('async');
var _ = require('lodash');

var cql = Promise.promisifyAll(require('dse-driver'));
var ORM = Promise.promisifyAll(require('./orm/apollo'));
var debug = require('debug')('express-cassandra');

var CassandraClient = function f(options) {
  var self = this;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
};

CassandraClient.createClient = function (options) {
  return new CassandraClient(options);
};

CassandraClient.setDirectory = function (directory) {
  CassandraClient.directory = directory;
  return CassandraClient;
};

CassandraClient.bind = function (options, cb) {
  var self = CassandraClient;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
  self.orm.connect(function (err) {
    if (err) {
      if (cb) cb(err);
      return;
    }

    fs.readdir(self.directory, function (err1, list) {
      if (err1) {
        if (cb) cb(err1);
        return;
      }

      async.each(list, function (file, callback) {
        var fileName = util.format('%s/%s', self.directory, file);
        var validFileExtensions = ['js', 'javascript', 'jsx', 'coffee', 'coffeescript', 'iced', 'script', 'ts', 'tsx', 'typescript', 'cjsx', 'co', 'json', 'json5', 'litcoffee', 'liticed', 'ls', 'node', 'toml', 'wisp'];
        var fileExtension = _.last(fileName.split('.')).toLowerCase();

        if (fileName.indexOf('Model') === -1 || validFileExtensions.indexOf(fileExtension) === -1) {
          callback();
          return;
        }

        var modelName = self._translateFileNameToModelName(file);

        if (modelName) {
          // eslint-disable-next-line import/no-dynamic-require
          var modelSchema = require(fileName);
          self.modelInstance[modelName] = self.orm.add_model(modelName.toLowerCase(), modelSchema, function (err2) {
            if (err2) callback(err2);else callback();
          });
          self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
        } else {
          callback();
        }
      }, function (err3) {
        if (err3 && cb) {
          cb(err3);
        } else if (cb) {
          cb();
        }
      });
    });
  });
};

CassandraClient.bindAsync = Promise.promisify(CassandraClient.bind);

CassandraClient.prototype.connect = function f(callback) {
  var self = this;
  self.orm.connect(callback);
};

CassandraClient.prototype.connectAsync = Promise.promisify(CassandraClient.prototype.connect);

CassandraClient.prototype.loadSchema = function f(modelName, modelSchema, callback) {
  var self = this;
  var cb = function cb(err) {
    if (typeof callback === 'function') {
      if (err) callback(err);else callback(null, self.modelInstance[modelName]);
    }
  };
  self.modelInstance[modelName] = self.orm.add_model(modelName, modelSchema, cb);
  self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
  return self.modelInstance[modelName];
};

CassandraClient.prototype.loadSchemaAsync = function f(modelName, modelSchema) {
  var _this = this;

  return new Promise(function (resolve, reject) {
    _this.loadSchema(modelName, modelSchema, function (err, Model) {
      if (err) reject(err);else resolve(Model);
    });
  });
};

CassandraClient.uuid = function () {
  return cql.types.Uuid.random();
};

CassandraClient.uuidFromString = function (str) {
  return cql.types.Uuid.fromString(str);
};

CassandraClient.timeuuid = function () {
  return cql.types.TimeUuid.now();
};

CassandraClient.timeuuidFromDate = function (date) {
  return cql.types.TimeUuid.fromDate(date);
};

CassandraClient.timeuuidFromString = function (str) {
  return cql.types.TimeUuid.fromString(str);
};

CassandraClient.maxTimeuuid = function (date) {
  return cql.types.TimeUuid.max(date);
};

CassandraClient.minTimeuuid = function (date) {
  return cql.types.TimeUuid.min(date);
};

CassandraClient.prototype.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  var randomModel = this.modelInstance[Object.keys(this.modelInstance)[0]];
  var builtQueries = [];
  for (var i = 0; i < queries.length; i++) {
    builtQueries.push({
      query: queries[i].query,
      params: queries[i].params
    });
  }
  if (builtQueries.length > 1) {
    randomModel.execute_batch(builtQueries, options, function (err) {
      if (err) callback(err);else callback();
    });
    return;
  }
  if (builtQueries.length > 0) {
    debug('single query provided for batch request, applying as non batch query');
    randomModel.execute_query(builtQueries[0].query, builtQueries[0].params, options, function (err) {
      if (err) callback(err);else callback();
    });
    return;
  }
  debug('no queries provided for batch request, empty array found, doing nothing');
  callback();
};

CassandraClient.prototype.doBatchAsync = Promise.promisify(CassandraClient.prototype.doBatch);

CassandraClient.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  CassandraClient.prototype.doBatch.call(CassandraClient, queries, options, callback);
};

CassandraClient.doBatchAsync = Promise.promisify(CassandraClient.doBatch);

CassandraClient._translateFileNameToModelName = function (fileName) {
  return fileName.slice(0, fileName.lastIndexOf('.')).replace('Model', '');
};

Object.defineProperties(CassandraClient, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return CassandraClient.modelInstance;
    }
  },
  close: {
    get: function get() {
      return CassandraClient.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(CassandraClient.orm.close);
    }
  }
});

Object.defineProperties(CassandraClient.prototype, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return this.modelInstance;
    }
  },
  close: {
    get: function get() {
      return this.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(this.orm.close);
    }
  }
});

CassandraClient.prototype.uuid = CassandraClient.uuid;
CassandraClient.prototype.uuidFromString = CassandraClient.uuidFromString;
CassandraClient.prototype.timeuuid = CassandraClient.timeuuid;
CassandraClient.prototype.timeuuidFromDate = CassandraClient.timeuuidFromDate;
CassandraClient.prototype.timeuuidFromString = CassandraClient.timeuuidFromString;
CassandraClient.prototype.maxTimeuuid = CassandraClient.maxTimeuuid;
CassandraClient.prototype.minTimeuuid = CassandraClient.minTimeuuid;

CassandraClient.prototype._translateFileNameToModelName = CassandraClient._translateFileNameToModelName;

module.exports = CassandraClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzQ2Fzc2FuZHJhLmpzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiZnMiLCJ1dGlsIiwiYXN5bmMiLCJfIiwiY3FsIiwicHJvbWlzaWZ5QWxsIiwiT1JNIiwiZGVidWciLCJDYXNzYW5kcmFDbGllbnQiLCJmIiwib3B0aW9ucyIsInNlbGYiLCJtb2RlbEluc3RhbmNlIiwib3JtIiwiY2xpZW50T3B0aW9ucyIsIm9ybU9wdGlvbnMiLCJjcmVhdGVDbGllbnQiLCJzZXREaXJlY3RvcnkiLCJkaXJlY3RvcnkiLCJiaW5kIiwiY2IiLCJjb25uZWN0IiwiZXJyIiwicmVhZGRpciIsImVycjEiLCJsaXN0IiwiZWFjaCIsImZpbGUiLCJjYWxsYmFjayIsImZpbGVOYW1lIiwiZm9ybWF0IiwidmFsaWRGaWxlRXh0ZW5zaW9ucyIsImZpbGVFeHRlbnNpb24iLCJsYXN0Iiwic3BsaXQiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJtb2RlbE5hbWUiLCJfdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZSIsIm1vZGVsU2NoZW1hIiwiYWRkX21vZGVsIiwiZXJyMiIsImVycjMiLCJiaW5kQXN5bmMiLCJwcm9taXNpZnkiLCJwcm90b3R5cGUiLCJjb25uZWN0QXN5bmMiLCJsb2FkU2NoZW1hIiwibG9hZFNjaGVtYUFzeW5jIiwicmVzb2x2ZSIsInJlamVjdCIsIk1vZGVsIiwidXVpZCIsInR5cGVzIiwiVXVpZCIsInJhbmRvbSIsInV1aWRGcm9tU3RyaW5nIiwic3RyIiwiZnJvbVN0cmluZyIsInRpbWV1dWlkIiwiVGltZVV1aWQiLCJub3ciLCJ0aW1ldXVpZEZyb21EYXRlIiwiZGF0ZSIsImZyb21EYXRlIiwidGltZXV1aWRGcm9tU3RyaW5nIiwibWF4VGltZXV1aWQiLCJtYXgiLCJtaW5UaW1ldXVpZCIsIm1pbiIsImRvQmF0Y2giLCJxdWVyaWVzIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiZGVmYXVsdHMiLCJwcmVwYXJlIiwiZGVmYXVsdHNEZWVwIiwicmFuZG9tTW9kZWwiLCJPYmplY3QiLCJrZXlzIiwiYnVpbHRRdWVyaWVzIiwiaSIsInB1c2giLCJxdWVyeSIsInBhcmFtcyIsImV4ZWN1dGVfYmF0Y2giLCJleGVjdXRlX3F1ZXJ5IiwiZG9CYXRjaEFzeW5jIiwiY2FsbCIsInNsaWNlIiwibGFzdEluZGV4T2YiLCJyZXBsYWNlIiwiZGVmaW5lUHJvcGVydGllcyIsImNvbnNpc3RlbmNpZXMiLCJnZXQiLCJkYXRhdHlwZXMiLCJkcml2ZXIiLCJpbnN0YW5jZSIsImNsb3NlIiwiY2xvc2VBc3luYyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCOztBQUVBLElBQU1DLEtBQUtELFFBQVEsSUFBUixDQUFYO0FBQ0EsSUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLE9BQVIsQ0FBZDtBQUNBLElBQU1JLElBQUlKLFFBQVEsUUFBUixDQUFWOztBQUVBLElBQU1LLE1BQU1OLFFBQVFPLFlBQVIsQ0FBcUJOLFFBQVEsWUFBUixDQUFyQixDQUFaO0FBQ0EsSUFBTU8sTUFBTVIsUUFBUU8sWUFBUixDQUFxQk4sUUFBUSxjQUFSLENBQXJCLENBQVo7QUFDQSxJQUFNUSxRQUFRUixRQUFRLE9BQVIsRUFBaUIsbUJBQWpCLENBQWQ7O0FBRUEsSUFBTVMsa0JBQWtCLFNBQVNDLENBQVQsQ0FBV0MsT0FBWCxFQUFvQjtBQUMxQyxNQUFNQyxPQUFPLElBQWI7QUFDQUEsT0FBS0MsYUFBTCxHQUFxQixFQUFyQjtBQUNBRCxPQUFLRSxHQUFMLEdBQVcsSUFBSVAsR0FBSixDQUFRSSxRQUFRSSxhQUFoQixFQUErQkosUUFBUUssVUFBdkMsQ0FBWDtBQUNELENBSkQ7O0FBTUFQLGdCQUFnQlEsWUFBaEIsR0FBK0IsVUFBQ04sT0FBRDtBQUFBLFNBQWMsSUFBSUYsZUFBSixDQUFvQkUsT0FBcEIsQ0FBZDtBQUFBLENBQS9COztBQUVBRixnQkFB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O0FBcUJqRHNGLFNBQU87QUFDTEosT0FESyxpQkFDQztBQUNKLGFBQU8sS0FBS2pGLEdBQUwsQ0FBU3FGLEtBQWhCO0FBQ0Q7QUFISSxHQXJCMEM7QUEwQmpEQyxjQUFZO0FBQ1ZMLE9BRFUsaUJBQ0o7QUFDSixhQUFPaEcsUUFBUThDLFNBQVIsQ0FBa0IsS0FBSy9CLEdBQUwsQ0FBU3FGLEtBQTNCLENBQVA7QUFDRDtBQUhTO0FBMUJxQyxDQUFuRDs7QUFrQ0ExRixnQkFBZ0JxQyxTQUFoQixDQUEwQk8sSUFBMUIsR0FBaUM1QyxnQkFBZ0I0QyxJQUFqRDtBQUNBNUMsZ0JBQWdCcUMsU0FBaEIsQ0FBMEJXLGNBQTFCLEdBQTJDaEQsZ0JBQWdCZ0QsY0FBM0Q7QUFDQWhELGdCQUFnQnFDLFNBQWhCLENBQTBCYyxRQUExQixHQUFxQ25ELGdCQUFnQm1ELFFBQXJEO0FBQ0FuRCxnQkFBZ0JxQyxTQUFoQixDQUEwQmlCLGdCQUExQixHQUE2Q3RELGdCQUFnQnNELGdCQUE3RDtBQUNBdEQsZ0JBQWdCcUMsU0FBaEIsQ0FBMEJvQixrQkFBMUIsR0FBK0N6RCxnQkFBZ0J5RCxrQkFBL0Q7QUFDQXpELGdCQUFnQnFDLFNBQWhCLENBQTBCcUIsV0FBMUIsR0FBd0MxRCxnQkFBZ0IwRCxXQUF4RDtBQUNBMUQsZ0JBQWdCcUMsU0FBaEIsQ0FBMEJ1QixXQUExQixHQUF3QzVELGdCQUFnQjRELFdBQXhEOztBQUVBNUQsZ0JBQWdCcUMsU0FBaEIsQ0FBMEJQLDZCQUExQixHQUEwRDlCLGdCQUFnQjhCLDZCQUExRTs7QUFFQThELE9BQU9DLE9BQVAsR0FBaUI3RixlQUFqQiIsImZpbGUiOiJleHByZXNzQ2Fzc2FuZHJhLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5cbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5jb25zdCBhc3luYyA9IHJlcXVpcmUoJ2FzeW5jJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IGNxbCA9IFByb21pc2UucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ2RzZS1kcml2ZXInKSk7XG5jb25zdCBPUk0gPSBQcm9taXNlLnByb21pc2lmeUFsbChyZXF1aXJlKCcuL29ybS9hcG9sbG8nKSk7XG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2V4cHJlc3MtY2Fzc2FuZHJhJyk7XG5cbmNvbnN0IENhc3NhbmRyYUNsaWVudCA9IGZ1bmN0aW9uIGYob3B0aW9ucykge1xuICBjb25zdCBzZWxmID0gdGhpcztcbiAgc2VsZi5tb2RlbEluc3RhbmNlID0ge307XG4gIHNlbGYub3JtID0gbmV3IE9STShvcHRpb25zLmNsaWVudE9wdGlvbnMsIG9wdGlvbnMub3JtT3B0aW9ucyk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQuY3JlYXRlQ2xpZW50ID0gKG9wdGlvbnMpID0+IChuZXcgQ2Fzc2FuZHJhQ2xpZW50KG9wdGlvbnMpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnNldERpcmVjdG9yeSA9IChkaXJlY3RvcnkpID0+IHtcbiAgQ2Fzc2FuZHJhQ2xpZW50LmRpcmVjdG9yeSA9IGRpcmVjdG9yeTtcbiAgcmV0dXJuIENhc3NhbmRyYUNsaWVudDtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5iaW5kID0gKG9wdGlvbnMsIGNiKSA9PiB7XG4gIGNvbnN0IHNlbGYgPSBDYXNzYW5kcmFDbGllbnQ7XG4gIHNlbGYubW9kZWxJbnN0YW5jZSA9IHt9O1xuICBzZWxmLm9ybSA9IG5ldyBPUk0ob3B0aW9ucy5jbGllbnRPcHRpb25zLCBvcHRpb25zLm9ybU9wdGlvbnMpO1xuICBzZWxmLm9ybS5jb25uZWN0KChlcnIpID0+IHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBpZiAoY2IpIGNiKGVycik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZnMucmVhZGRpcihzZWxmLmRpcmVjdG9yeSwgKGVycjEsIGxpc3QpID0+IHtcbiAgICAgIGlmIChlcnIxKSB7XG4gICAgICAgIGlmIChjYikgY2IoZXJyMSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgYXN5bmMuZWFjaChsaXN0LCAoZmlsZSwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSB1dGlsLmZvcm1hdCgnJXMvJXMnLCBzZWxmLmRpcmVjdG9yeSwgZmlsZSk7XG4gICAgICAgIGNvbnN0IHZhbGlkRmlsZUV4dGVuc2lvbnMgPSBbXG4gICAgICAgICAgJ2pzJywgJ2phdmFzY3JpcHQnLCAnanN4JywgJ2NvZmZlZScsICdjb2ZmZWVzY3JpcHQnLCAnaWNlZCcsXG4gICAgICAgICAgJ3NjcmlwdCcsICd0cycsICd0c3gnLCAndHlwZXNjcmlwdCcsICdjanN4JywgJ2NvJywgJ2pzb24nLFxuICAgICAgICAgICdqc29uNScsICdsaXRjb2ZmZWUnLCAnbGl0aWNlZCcsICdscycsICdub2RlJywgJ3RvbWwnLCAnd2lzcCcsXG4gICAgICAgIF07XG4gICAgICAgIGNvbnN0IGZpbGVFeHRlbnNpb24gPSBfLmxhc3QoZmlsZU5hbWUuc3BsaXQoJy4nKSkudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICBpZiAoZmlsZU5hbWUuaW5kZXhPZignTW9kZWwnKSA9PT0gLTEgfHwgdmFsaWRGaWxlRXh0ZW5zaW9ucy5pbmRleE9mKGZpbGVFeHRlbnNpb24pID09PSAtMSkge1xuICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbW9kZWxOYW1lID0gc2VsZi5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZShmaWxlKTtcblxuICAgICAgICBpZiAobW9kZWxOYW1lKSB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgICAgICBjb25zdCBtb2RlbFNjaGVtYSA9IHJlcXVpcmUoZmlsZU5hbWUpO1xuICAgICAgICAgIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gc2VsZi5vcm0uYWRkX21vZGVsKFxuICAgICAgICAgICAgbW9kZWxOYW1lLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBtb2RlbFNjaGVtYSxcbiAgICAgICAgICAgIChlcnIyKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlcnIyKSBjYWxsYmFjayhlcnIyKTtcbiAgICAgICAgICAgICAgZWxzZSBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gUHJvbWlzZS5wcm9taXNpZnlBbGwoc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIChlcnIzKSA9PiB7XG4gICAgICAgIGlmIChlcnIzICYmIGNiKSB7XG4gICAgICAgICAgY2IoZXJyMyk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2IpIHtcbiAgICAgICAgICBjYigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQuYmluZEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LmJpbmQpO1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmNvbm5lY3QgPSBmdW5jdGlvbiBmKGNhbGxiYWNrKSB7XG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuICBzZWxmLm9ybS5jb25uZWN0KGNhbGxiYWNrKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuY29ubmVjdEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5jb25uZWN0KTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5sb2FkU2NoZW1hID0gZnVuY3Rpb24gZihtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCBjYWxsYmFjaykge1xuICBjb25zdCBzZWxmID0gdGhpcztcbiAgY29uc3QgY2IgPSBmdW5jdGlvbiBjYihlcnIpIHtcbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBpZiAoZXJyKSBjYWxsYmFjayhlcnIpO1xuICAgICAgZWxzZSBjYWxsYmFjayhudWxsLCBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSk7XG4gICAgfVxuICB9O1xuICBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSA9IHNlbGYub3JtLmFkZF9tb2RlbChtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCBjYik7XG4gIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gUHJvbWlzZS5wcm9taXNpZnlBbGwoc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0pO1xuICByZXR1cm4gc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV07XG59O1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmxvYWRTY2hlbWFBc3luYyA9IGZ1bmN0aW9uIGYobW9kZWxOYW1lLCBtb2RlbFNjaGVtYSkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHRoaXMubG9hZFNjaGVtYShtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCAoZXJyLCBNb2RlbCkgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICBlbHNlIHJlc29sdmUoTW9kZWwpO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC51dWlkID0gKCkgPT4gKGNxbC50eXBlcy5VdWlkLnJhbmRvbSgpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnV1aWRGcm9tU3RyaW5nID0gKHN0cikgPT4gKGNxbC50eXBlcy5VdWlkLmZyb21TdHJpbmcoc3RyKSk7XG5cbkNhc3NhbmRyYUNsaWVudC50aW1ldXVpZCA9ICgpID0+IChjcWwudHlwZXMuVGltZVV1aWQubm93KCkpO1xuXG5DYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tRGF0ZSA9IChkYXRlKSA9PiAoY3FsLnR5cGVzLlRpbWVVdWlkLmZyb21EYXRlKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbVN0cmluZyA9IChzdHIpID0+IChjcWwudHlwZXMuVGltZVV1aWQuZnJvbVN0cmluZyhzdHIpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1heFRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWF4KGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50Lm1pblRpbWV1dWlkID0gKGRhdGUpID0+IChjcWwudHlwZXMuVGltZVV1aWQubWluKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoID0gZnVuY3Rpb24gZihxdWVyaWVzLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgIGNhbGxiYWNrID0gb3B0aW9ucztcbiAgICBvcHRpb25zID0ge307XG4gIH1cblxuICBjb25zdCBkZWZhdWx0cyA9IHtcbiAgICBwcmVwYXJlOiB0cnVlLFxuICB9O1xuXG4gIG9wdGlvbnMgPSBfLmRlZmF1bHRzRGVlcChvcHRpb25zLCBkZWZhdWx0cyk7XG5cbiAgY29uc3QgcmFuZG9tTW9kZWwgPSB0aGlzLm1vZGVsSW5zdGFuY2VbT2JqZWN0LmtleXModGhpcy5tb2RlbEluc3RhbmNlKVswXV07XG4gIGNvbnN0IGJ1aWx0UXVlcmllcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXJpZXMubGVuZ3RoOyBpKyspIHtcbiAgICBidWlsdFF1ZXJpZXMucHVzaCh7XG4gICAgICBxdWVyeTogcXVlcmllc1tpXS5xdWVyeSxcbiAgICAgIHBhcmFtczogcXVlcmllc1tpXS5wYXJhbXMsXG4gICAgfSk7XG4gIH1cbiAgaWYgKGJ1aWx0UXVlcmllcy5sZW5ndGggPiAxKSB7XG4gICAgcmFuZG9tTW9kZWwuZXhlY3V0ZV9iYXRjaChidWlsdFF1ZXJpZXMsIG9wdGlvbnMsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIGNhbGxiYWNrKGVycik7XG4gICAgICBlbHNlIGNhbGxiYWNrKCk7XG4gICAgfSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChidWlsdFF1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgIGRlYnVnKCdzaW5nbGUgcXVlcnkgcHJvdmlkZWQgZm9yIGJhdGNoIHJlcXVlc3QsIGFwcGx5aW5nIGFzIG5vbiBiYXRjaCBxdWVyeScpO1xuICAgIHJhbmRvbU1vZGVsLmV4ZWN1dGVfcXVlcnkoYnVpbHRRdWVyaWVzWzBdLnF1ZXJ5LCBidWlsdFF1ZXJpZXNbMF0ucGFyYW1zLCBvcHRpb25zLCAoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSBjYWxsYmFjayhlcnIpO1xuICAgICAgZWxzZSBjYWxsYmFjaygpO1xuICAgIH0pO1xuICAgIHJldHVybjtcbiAgfVxuICBkZWJ1Zygnbm8gcXVlcmllcyBwcm92aWRlZCBmb3IgYmF0Y2ggcmVxdWVzdCwgZW1wdHkgYXJyYXkgZm91bmQsIGRvaW5nIG5vdGhpbmcnKTtcbiAgY2FsbGJhY2soKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuZG9CYXRjaEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmRvQmF0Y2ggPSBmdW5jdGlvbiBmKHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgIG9wdGlvbnMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IGRlZmF1bHRzID0ge1xuICAgIHByZXBhcmU6IHRydWUsXG4gIH07XG5cbiAgb3B0aW9ucyA9IF8uZGVmYXVsdHNEZWVwKG9wdGlvbnMsIGRlZmF1bHRzKTtcblxuICBDYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmRvQmF0Y2guY2FsbChDYXNzYW5kcmFDbGllbnQsIHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5kb0JhdGNoQXN5bmMgPSBQcm9taXNlLnByb21pc2lmeShDYXNzYW5kcmFDbGllbnQuZG9CYXRjaCk7XG5cbkNhc3NhbmRyYUNsaWVudC5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZSA9IChmaWxlTmFtZSkgPT4gKFxuICBmaWxlTmFtZS5zbGljZSgwLCBmaWxlTmFtZS5sYXN0SW5kZXhPZignLicpKS5yZXBsYWNlKCdNb2RlbCcsICcnKVxuKTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ2Fzc2FuZHJhQ2xpZW50LCB7XG4gIGNvbnNpc3RlbmNpZXM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsLnR5cGVzLmNvbnNpc3RlbmNpZXM7XG4gICAgfSxcbiAgfSxcbiAgZGF0YXR5cGVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcztcbiAgICB9LFxuICB9LFxuICBkcml2ZXI6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsO1xuICAgIH0sXG4gIH0sXG4gIGluc3RhbmNlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIENhc3NhbmRyYUNsaWVudC5tb2RlbEluc3RhbmNlO1xuICAgIH0sXG4gIH0sXG4gIGNsb3NlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIENhc3NhbmRyYUNsaWVudC5vcm0uY2xvc2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2VBc3luYzoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShDYXNzYW5kcmFDbGllbnQub3JtLmNsb3NlKTtcbiAgICB9LFxuICB9LFxufSk7XG5cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZSwge1xuICBjb25zaXN0ZW5jaWVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcy5jb25zaXN0ZW5jaWVzO1xuICAgIH0sXG4gIH0sXG4gIGRhdGF0eXBlczoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWwudHlwZXM7XG4gICAgfSxcbiAgfSxcbiAgZHJpdmVyOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbDtcbiAgICB9LFxuICB9LFxuICBpbnN0YW5jZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiB0aGlzLm1vZGVsSW5zdGFuY2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2U6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gdGhpcy5vcm0uY2xvc2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2VBc3luYzoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeSh0aGlzLm9ybS5jbG9zZSk7XG4gICAgfSxcbiAgfSxcbn0pO1xuXG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudXVpZCA9IENhc3NhbmRyYUNsaWVudC51dWlkO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS51dWlkRnJvbVN0cmluZyA9IENhc3NhbmRyYUNsaWVudC51dWlkRnJvbVN0cmluZztcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudGltZXV1aWQgPSBDYXNzYW5kcmFDbGllbnQudGltZXV1aWQ7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnRpbWV1dWlkRnJvbURhdGUgPSBDYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tRGF0ZTtcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudGltZXV1aWRGcm9tU3RyaW5nID0gQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbVN0cmluZztcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUubWF4VGltZXV1aWQgPSBDYXNzYW5kcmFDbGllbnQubWF4VGltZXV1aWQ7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLm1pblRpbWV1dWlkID0gQ2Fzc2FuZHJhQ2xpZW50Lm1pblRpbWV1dWlkO1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lID0gQ2Fzc2FuZHJhQ2xpZW50Ll90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lO1xuXG5tb2R1bGUuZXhwb3J0cyA9IENhc3NhbmRyYUNsaWVudDtcbiJdfQ==